charts <- function(content, topic, outcome, counted, timeperiod, goalu, goall, type, theme) {
temp <- content
# http://stat.ethz.ch/R-manual/R-devel/library/base/html/regex.html
#temp <- gsub('\n', '', fixed = TRUE, temp, perl = TRUE)
#temp <- gsub("\\s+$", "", temp, perl = TRUE) #Removing trailing whitespace
#temp <- gsub(",+$", "", temp, perl = TRUE) #Remove trailing comma if accidentally added by user online
temp <- gsub("\t", ' ', fixed = TRUE, temp)
temp <- gsub(',', '","', fixed = TRUE, temp)
temp <- paste('"',temp,'"',sep = '')
temp <- paste('Mymatrix <- matrix(c(',temp,'), ncol=4, byrow=TRUE, dimnames = list(NULL, c("periodname", "count", "total","Trial")))',sep = '')
x <- eval(parse(file = "", n = NULL, text = temp))
myframe <- data.frame (x)
myframe$period<-gsub("\'", '', fixed = TRUE, myframe$period)
myframe$period<-str_trim(as.character(myframe$period))
myframe$count<-as.numeric(as.character(str_trim(myframe$count)))
myframe$total<-as.numeric(as.character(str_trim(myframe$total)))
if (length(timeperiod) > 0)
	{timeperiod<-paste("Time period (",timeperiod,")",sep="")}
#myframe$Trial<-as.logical(str_trim(myframe$Trial))
myframe$Trial<-str_trim(as.character(myframe$Trial))
#myframe$Trial<-str_trim(myframe$Trial)
if (goalu < 0){goalu = 0}
if (goall < 0){goall = 0}
goalu <- as.numeric(goalu)
goall <- as.numeric(goall)

attach(myframe)
# http://www.identity.ku.edu/colors/index.shtml
KUBlue = "#0022B4"
SkyBlue = "#6DC6E7"
par(col.axis="black" ,col.lab=KUBlue ,col.main=KUBlue ,col.sub=KUBlue)
qcc.options("cex.stats"=0.9, "cex" = 2, "bg.margin"=SkyBlue,"run.length" = 6, "beyond.limits" = list(pch = 20, col = "black"), "violating.runs" = list(pch = 16, col = "orange")) #Shift. A run
sequential = FALSE
period = 0
for(i in 1: length(myframe$periodname))
{
period[i] = i
if(myframe$Trial[i] == '1')
	{
	sequential = TRUE
	}
else
	{
	}
#Trial[i] =as.logical(Trial[i])
#Below done to avoid handling strings such as "Jan, 2013"
#myframe$period[i] <- i
}
myframe <- cbind(myframe,period)
attach(myframe)

if (type == "r" || type == "R"){sequential = FALSE}

if (sequential == FALSE)
	{
	if (type == "p" || type == "P")
		{
		currentvalue <- count/total
		spc <- qcc(count,sizes=total,type="p", xlab="",ylab="",title="",labels=myframe$period,ylim=c(0,1), digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
		#mtext(bquote("Proportion of encounters"~~bolditalic(.(outcome))), side=2, line=2.5, col=KUBlue , cex=1.5)
		y.label = bquote("Count of encounters"~~bolditalic(.(outcome)))
		average = paste("Average ",outcome," = ",round(spc$center*100,digits = 1),"%", sep = "")
		if(theme=="KU"){display_logo(x=1.2,y=0.2)}
		}
	else 
		{
		if (type == "r" || type == "R") #Run chart
			{
			numerator = 0
			denominator = 0
			for(i in 1:length(period))
				{
				numerator <- numerator + count[i]
				denominator <- denominator + total[i]
				}
			par(fin=c(8.8,6))
			plot (row(myframe)[,1],count/total, ylim=c(0,1), xlab="", ylab="", type="b",xaxs="r",axes=F,,xaxt="n")
			axis(side=1,at=1:length(myframe$period),labels=myframe$period)
			axis(2,  xaxp=c(0,1,10))
			box()
			mtext(bquote("Proportion of encounters"~~bolditalic(.(outcome))), side=2, line=2.5, col=KUBlue , cex=1.5)
			average = paste("Average ",outcome," = ",round(100*numerator/denominator,digits = 1),"%", collapse = NULL)
			if(theme=="KU"){display_logo(x=1.15,y=0.06)}
			}
		else
			{
			if (type == "b" || type == "B") #Box plot
				{
				#This does not make sense. Cannot do box chart outside of a trial
				plot.new()
				topic= "Ooops"
				y.label = "oops"
				average=""
				}
			else #c-chart
				{
				if (counted == "events") 
					{
					currentvalue <- count
					spc <- qcc(count,type="c", xlab="",ylab="",title="",labels=myframe$period, digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
					y.label = bquote("Count of encounters"~~bolditalic(.(outcome)))
					}
				if (counted == "total")  
					{
					currentvalue <- total
					spc <- qcc(total,type="c", xlab="",ylab="",title="",labels=myframe$period, digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
					y.label = bquote("Count of "~~bolditalic(total)~~"encounters")
					}
				average = paste("Average ",outcome," = ",round(spc$center,digits = 1),"", sep = "")
				plot(spc, add.stats = TRUE, chart.all = TRUE, label.limits = c("LCL ", "UCL"), title = "", xlab="",ylab="", axes.las = 0, digits = 2)
				}
			}
		}
	par(new=TRUE,xpd=NA)
	plot.new()
	if (type=="R" || type=="r")
		{
		mtext(timeperiod, side=1, line=3, col=KUBlue , cex=1.5)
		mtext(average, side=1, line=4.5, col=KUBlue , cex=1)
		}
	else
		{
		#mtext(subtitle, side=3, line=0.5, col=KUBlue , cex=1.2)
		mtext(y.label, side=2, line=3.5, col=KUBlue , cex=1.5)
		mtext(timeperiod, side=1, line=-1.0, col=KUBlue , cex=1.5)
		mtext(average, side=1, line=-0.2, col=KUBlue , cex=1)
		
		}
	mtext(topic, side=3,line=2,col=KUBlue,font=2, cex=3)
	#Goals or targets
	par(new=TRUE,xpd=FALSE)
	if (goalu > 0 && goall > 0)
		{
		regionx = c(-1,-1,length(period) + 1,length(period) + 1)
		regiony = c(goall,goalu,goalu,goall)
		polygon(regionx,regiony,col=rgb(0,1,0,alpha=0.05),border = NA)
		axis(4,at=c(goall,goalu),labels=c(goall,goalu),col.ticks="green")
		}
	if (grepl("flu", topic) > 0 && grepl("vaccin", topic) > 0)
		{ #http://www.cdc.gov/flu/fluvaxview/reports/reporti1213/reportii/index.htm
		  # http://www.healthypeople.gov/2020/topicsobjectives2020/objectiveslist.aspx?topicId=23
			if (outcome == "nonconforming")
				{
				abline(a = 0.585, b = 0, col="red", lty = 2, lwd = 2)
				abline(a = 0.2, b = 0, col="green", lty = 2, lwd = 2)
				legend("topright", legend=c("National rate 2012-2013 (41.5%)","Healthy People 2020 goal (80%)"),col=c("red","green"),lty=2, lwd = 2, inset=0.05)
				}
			if (outcome == "conforming")
				{
				abline(a = 0.415, b = 0, col="red", lty = 2, lwd = 2)
				abline(a = 0.8, b = 0, col="green", lty = 2, lwd = 2)
				legend("topleft", legend=c("Healthy People 2020 goal (80%)","National rate 2012-2013 (41.5%)"),col=c("green","red"),lty=2, lwd = 2,  inset=0.05)
				}
		}
	if (grepl("re-admission", topic) > 0)
		{
		abline(a = 0.178, b = 0, col="red", lty = 2)
		abline(a = 0.122, b = 0, col="green", lty = 2)
		legend("topright", legend=c("Medicare (17.8%)","Kaiser (12.2%)"),col=c("red","green"),lty=2, inset=0.05)
		}
	}
else #sequential == TRUE
	{
	if (type == "b" || type == "B")
		{
		cella = 0
		cellb = 0
		cellc = 0
		celld = 0
		for(i in 1: length (period))
			{
			if (Trial[i] == 0)
				{
				cellc = cellc + count[i]
				celld = celld + (total[i] - count[i])
				}
			else
				{
				cella = cella + count[i]
				cellb = cellb + (total[i] - count[i])
				}
			}
		twobytwo=rbind(c(cella,cellb),c(cellc,celld))
		print("###########################################")
		print(twobytwo)
		names(Trial) <- c("Baseline","Trial")
		par(cex.main = 3)
		boxplot(count/total ~ Trial,ylab=bquote("Mean proportion of encounters"~~bolditalic(.(outcome))),main=topic, ylim=c(0,1),names.arg=c("Baseline","Trial"))
		axis(1, at= 1:2, lab=c("Baseline","Trial"),tick=FALSE, cex = 2)
		mtext(side=3,line=0.2,"(before and after analysis)", font=1)
		mm<-tapply(count/total,Trial, median,na.rm=TRUE)
		text(1-0.4,mm[1],round(mm[1],2),pos=2)
		text(2-0.4,mm[2],round(mm[2],2),pos=2)
		#median<-wilcox.test(count/total ~ Trial, alternative="two.sided")
		#text(2,0.95,paste("p=", round(median$p.value[1],3),"\n(non-parametric)"),adj=0,font=1,col='black')
		mean<-fisher.test(twobytwo)
		text(2,0.95,paste("p=", sprintf("%.3f",mean$p.value[1]),"\n(Fisher's Exact)"),adj=0,font=1,col='black')
		print (paste("p=",sprintf("%.3f",mean$p.value[1])))
		if(theme=="KU"){display_logo(x=1.2,y=0.05)}
		}
	else 
		{
		if (type == "p" || type == "P")
			{
			currentvalue <- count/total
			spc <- qcc(data=count[Trial=='0'],sizes=total[Trial=='0'],newdata=count[Trial=='1'], newsizes=total[Trial=='1'],type="p", xlab="",ylab="",title="",labels=periodname[Trial=='0'],newlabels=periodname[Trial=='1'],ylim=c(0,1), digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
			subtitle = "p chart: before-after trial"
			y.label = bquote("Proportion of encounters"~~bolditalic(.(outcome)))
			average = paste("Average (pretrial) = ",round(spc$center*100,digits = 1),"%", sep = "")
			##Sig testing
			#Linear regression
			glm.out1=glm(count/total ~ as.numeric(Trial) + period, family=binomial(logit),weights = total)
			plot(spc, add.stats = TRUE, chart.all = TRUE, label.limits = c("LCL ", "UCL"), title = "", xlab="",ylab="", ylim=c(0,1),axes.las = 0, digits = 2)
			}
		if (type == "c" || type == "C")
			{
			if (counted == "events") 
				{
				currentvalue <- count
				spc <- qcc(count[Trial=="0"],newdata=count[Trial=="1"],type="c", xlab="",ylab="",title="",labels=periodname[Trial=="0"],newlabels=periodname[Trial=="1"], digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
				glm.out1=glm(count ~ as.numeric(Trial) + period, family=poisson(log))
				subtitle = "c chart) before-after trial"
				y.label = bquote("Count of encounters"~~bolditalic(.(outcome)))
				}
			if (counted == "total") 
				{
				currentvalue <- total
				spc <- qcc(total[Trial=="0"],newdata=total[Trial=="1"],type="c", xlab="",ylab="",title="",labels=periodname[Trial=="0"],newlabels=periodname[Trial=="1"], digits=2,nsigmas=3,chart.all=TRUE,add.stats=TRUE)
				glm.out1=glm(total ~ as.numeric(Trial) + period, family=poisson(log))
				#mtext("Count of encounters", side=2, line=2.5, col=KUBlue , cex=1.5)
				subtitle = "c chart: before-after trial"
				y.label = bquote("Count of encounters"~~bolditalic(.(outcome)))
				}
			mtext(side=3,line=1,"c chart: before-after trial", font=2)
			average = paste("Average (pretrial) = ",round(spc$center,digits = 1),"", sep = "")
			plot(spc, add.stats = TRUE, chart.all = TRUE, label.limits = c("LCL ", "UCL"), title = "", xlab="",ylab="", axes.las = 0, digits = 2)
			##Sig testing
			#Linear regression
			}
		par(new=TRUE,xpd=NA)
		plot.new()
		mtext(timeperiod, side=1, line=-1.1, col=KUBlue , cex=1.3, outer = FALSE)
		mtext(average, side=1, line=-0.1, col=KUBlue , cex=1,  outer = FALSE)
		mtext(y.label, side=2, line=3.5, col=KUBlue , cex=1.5)
		mtext(topic, side=3, line=2, col=KUBlue, font = 2, cex=3)
		mtext(subtitle, side=3, line=0.8, col=KUBlue , cex=1.2)

		sum.sig <- summary(glm.out1)
		#coef(sum.sig)["Trial",4] or coef(sum.sig)[2,4]
		#plot(period, count/total,xlab="", ylim=c(0,1))
		#mtext(period, side=1, line=2, col=KUBlue , cex=1)
		#lines(period, glm.out1$fitted,type="l",col="red")
		significance = paste("P-value for trial (linear regression) = ",format(round(coef(sum.sig)["as.numeric(Trial)",4],digits = 3), nsmall = 3), sep = "")
		mtext(significance, side=1, line=0.5, col=KUBlue , cex=1,adj = 1)
		significance = paste("P-value for secular change (linear regression) = ",format(round(coef(sum.sig)["period",4],digits = 3), nsmall = 3), sep = "")
		mtext(significance, side=1, line=1.5, col=KUBlue , cex=1,adj = 1)
		if(theme=="KU"){display_logo(x=1.2,y=0.2)}
		#Goals or targets
		if (goalu > 0 && goall > 0)
			{
			regionx = c(0,0,length(period) + 1,length(period) + 1)
			regiony = c(goall,goalu,goalu,goall)
			polygon(regionx,regiony,col=rgb(0,1,0,alpha=0.05),border = NA)
			axis(4,at=c(goall,goalu),labels=c(goall,goalu),col.ticks="green")
			}
		if (grepl("flu", topic) > 0 && grepl("vaccin", topic) > 0)
			{ #http://www.cdc.gov/flu/fluvaxview/reports/reporti1213/reportii/index.htm
			  # http://www.healthypeople.gov/2020/topicsobjectives2020/objectiveslist.aspx?topicId=23
			if (outcome == "nonconforming")
				{
				abline(a = 0.585, b = 0, col="red", lty = 2, lwd = 2)
				abline(a = 0.2, b = 0, col="green", lty = 2, lwd = 2)
				legend("topright", legend=c("National rate 2012-2013 (41.5%)","Healthy People 2020 goal (80%)"),col=c("red","green"),lty=2, lwd = 2, inset=0.05)
				}
			if (outcome == "conforming")
				{
				abline(a = 0.415, b = 0, col="red", lty = 2, lwd = 2)
				abline(a = 0.8, b = 0, col="green", lty = 2, lwd = 2)
				legend("topleft", legend=c("Healthy People 2020 goal (80%)","National rate 2012-2013 (41.5%)"),col=c("green","red"),lty=2, lwd = 2,  inset=0.05)
				}
			}
		if (grepl("re-admission", topic))
			{
			abline(a = 0.178, b = 0, col="red", lty = 2)
			abline(a = 0.122, b = 0, col="green", lty = 2)
			legend("topright", legend=c("Medicare (17.8%)","Kaiser (12.2%)"),col=c("red","green"),lty=2, inset=0.05)
			}
		}
	}
	#Shewhart rules start
	if (type != "r" && type != "R" && type != "b" && type != "B")
		{
		lastvalue = 0
		Trend = 0
		Trend.items <- numeric()
		#currentvalue <- numeric()
		for(i in 1: length (myframe$period))
		{
		# $IHI rules http://www.ihi.org/knowledge/Pages/Tools/RunChart.aspx
		# IHI1: Trend of 5 or more consecutively changing in the same direction
		# if (type=="p" || type=="P") {currentvalue[i] <- myframe$d[i]/myframe$total[i]}
		# if (type=="c" || type=="C") {currentvalue[i] <- myframe$d[i]}
		if(currentvalue[i] > lastvalue)
			{
			if (Trend < 0) {Trend = 2}
			else {Trend = Trend + 1}
			}
		if(currentvalue[i] < lastvalue)
			{
			if (Trend > 0) {Trend = - 2}
			else{Trend = Trend - 1}
			}
		if (Trend > 4 || Trend < -4)
			{
			Trend.items <- c(Trend.items, i)
			}
		# IHI2: Run of 6 or more on same size of median
		# Built in so not coded here
		lastvalue = currentvalue[i]
		}
		#Trend.items

		shewhart <- shewhart.rules(spc, run.length = 6)
			
		#For debugging
		#text (0.5,1,paste("Length of period: ", length (myframe$period)))
		for(i in 1: length (myframe$period))
			{
			#2014-04-01: This causes the last point to be missplaced
			# Cannot easily be fixed with new QCC library
			#points ((i-1)/(length(myframe$period) - 1),currentvalue[i], col="black",pch=16, cex = 1)
			#For debugging
			#text (row(myframe)[i,1],currentvalue[i],i,adj = c(0,-1))
			}

		# IHI1: Trend of 5 or more consecutively changing in the same direction
		# Trend.items
		for(i in 1: length (myframe$period))
		{
		if (any(Trend.items == i+1) == TRUE)
			{
			Trend.items <- c(i-3,i-2,i-1,i,Trend.items)
			}
		}

		Trend.items <-   sort(Trend.items)
		Trend.items <- unique(Trend.items)
		for(i in 1: length (Trend.items))
			{
			#points (Trend.items[i],currentvalue[Trend.items[i]], col="blue",pch=21, cex = 1.5)
			#lines ((Trend.items[i]-1)/(length (myframe$period) - 1),currentvalue[Trend.items[i]],col="blue",lwd=1.5)
			}
		#Below will work if can adjust for margins top and bottom
		#lines ((Trend.items-1)/(length (myframe$period) - 1),currentvalue[Trend.items],type="l",col="blue",lwd=1.5)

		# IHI2: Run of 6 or more on same size of median
		# shewhart$violating.runs
		vr <- violating.runs(spc, run.length = 6)
		for(i in 1: length (vr))
			{
			#Below will work better if can adjust for margins top and bottom
			#points ((vr[i] - 1)/(length (myframe$period) - 1),currentvalue[vr[i]], col="orange",pch=16, cex = 1)
			}			

		# IHI4:astronomical points
		for(i in 1: length (shewhart$beyond.limits))
			{
			#Not needed with new library
			#points ((shewhart$beyond.limits[i] - 1)/(length (myframe$period) - 1),currentvalue[shewhart$beyond.limits[i]], col="red",pch=21, cex = 2)
			}
		#Shewhart rules end
		}
}
